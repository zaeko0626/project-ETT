<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETT - PPE System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Manrope', sans-serif; background-color: #f1f5f9; height: 100vh; overflow: hidden; }
        
        .main-wrapper { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
        #sidebar { 
            position: fixed; left: 0; top: 0; bottom: 0; width: 280px; 
            background: #0f172a; color: white; z-index: 100;
            transform: translateX(-100%); transition: transform 0.3s ease;
        }
        #sidebar.open { transform: translateX(0); }
        @media (min-width: 1024px) {
            #sidebar { position: relative; transform: translateX(0); }
            #sidebar-overlay { display: none !important; }
        }

        .nav-btn {
            width: 100%; padding: 14px 20px; border-radius: 12px;
            display: flex; align-items: center; font-weight: 800; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.05em;
            transition: 0.2s; margin-bottom: 6px; color: #94a3b8;
        }
        .nav-btn i { width: 28px; font-size: 18px; margin-right: 12px; text-align: center; }
        .nav-btn:hover { background: #1e293b; color: white; }
        .nav-btn.active { background: #2563eb; color: white; }

        .content-area { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .tab-content { flex: 1; overflow-y: auto; padding: 16px; }
        
        .mobile-header { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 12px 20px; background: #0f172a; color: white; flex-shrink: 0;
        }

        /* Хүснэгтэн загвар */
        .order-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .card-grid { display: grid; grid-template-columns: 1.5fr 1.5fr 0.8fr 1fr; padding: 16px 20px; align-items: center; gap: 15px; }
        
        .label-text { font-size: 9px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }
        .value-name { font-size: 13px; font-weight: 800; color: #1e293b; text-transform: uppercase; }
        .value-sub { font-size: 10px; font-weight: 700; color: #2563eb; text-transform: uppercase; margin-top: 2px; }
        .value-item { font-size: 12px; font-weight: 800; color: #1e293b; text-transform: uppercase; }
        .value-detail { font-size: 10px; font-weight: 600; color: #64748b; margin-top: 2px; }

        .btn-action { padding: 8px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-approve { background: #ecfdf5; color: #059669; border: 1px solid #10b981; }
        .btn-approve:hover { background: #10b981; color: white; }
        .btn-reject { background: #fef2f2; color: #dc2626; border: 1px solid #ef4444; }
        .btn-reject:hover { background: #ef4444; color: white; }
        
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 9px; font-weight: 800; text-transform: uppercase; display: inline-block; }
        .status-huleeh { background: #fffbeb; color: #d97706; }
        .status-olgoson { background: #f0fdf4; color: #16a34a; }
        .status-tatgalzsan { background: #fef2f2; color: #dc2626; }

        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-2"></div>
        <p class="text-[10px] font-black text-blue-600 uppercase italic">Түр хүлээнэ үү...</p>
    </div>

    <div id="login-page" class="flex h-screen items-center justify-center p-6 bg-slate-100">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-4xl font-black mb-10 italic text-slate-900">ETT <span class="text-blue-600">PPE</span></h1>
            <input type="text" id="login-code" placeholder="Ажилтны код" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 font-bold text-center outline-none">
            <input type="password" id="login-pass" placeholder="Нууц үг" class="w-full p-4 bg-slate-50 border rounded-2xl mb-6 font-bold text-center outline-none">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase shadow-lg active:scale-95 transition-all">Нэвтрэх</button>
        </div>
    </div>

    <div id="main-page" class="hidden main-wrapper">
        <div id="sidebar" class="flex flex-col">
            <div class="p-6 border-b border-slate-800">
                <h1 class="font-black italic text-xl uppercase text-white">ETT <span class="text-blue-500">PPE</span></h1>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-1">
                <button onclick="showTab('orders', this)" class="nav-btn active"><i class="fas fa-list-ul text-blue-400"></i> БҮХ ХҮСЭЛТҮҮД</button>
                <button id="admin-nav-item" onclick="showTab('admin-panel', this)" class="nav-btn"><i class="fas fa-user-shield text-amber-400"></i> УДИРДЛАГА</button>
                <button onclick="showTab('settings', this)" class="nav-btn"><i class="fas fa-key text-red-400"></i> НУУЦ ҮГ</button>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full bg-red-600/20 border border-red-500/50 p-3 rounded-xl text-red-500 font-black text-[10px] uppercase flex items-center justify-center hover:bg-red-600 hover:text-white transition-all">
                    <i class="fas fa-power-off mr-2"></i> СИСТЕМЭЭС ГАРАХ
                </button>
            </div>
        </div>

        <div class="content-area">
            <header class="mobile-header">
                <button onclick="toggleSidebar()" class="text-xl lg:hidden"><i class="fas fa-bars"></i></button>
                <span id="header-title" class="font-black italic text-[11px] uppercase">ХҮСЭЛТИЙН ЖАГСААЛТ</span>
                <button onclick="refreshData()" class="bg-blue-600 px-4 py-2 rounded-xl text-white font-black text-[10px] uppercase flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i> ШИНЭЧЛЭХ
                </button>
            </header>

            <main class="tab-content">
                <div id="tab-orders">
                    <div id="orders-list-container" class="space-y-2 pb-24"></div>
                </div>

                <div id="tab-admin-panel" class="hidden space-y-6">
                    <div class="bg-white p-6 rounded-3xl border border-slate-200">
                        <h3 class="text-blue-600 font-black text-[10px] uppercase mb-4 border-b pb-2">Нэг бүрийн хамгаалах хэрэгсэл нэмэх</h3>
                        <input type="text" id="new-item-name" placeholder="Барааны нэр" class="w-full p-4 bg-slate-50 border rounded-2xl mb-3 font-bold text-xs outline-none">
                        <input type="text" id="new-item-sizes" placeholder="Размерууд (38,39,40...)" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 font-bold text-xs outline-none">
                        <button onclick="addNewItem()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-[10px]">Бүртгэх</button>
                    </div>
                </div>

                <div id="tab-settings" class="hidden">
                    <div class="max-w-sm mx-auto bg-white p-10 rounded-3xl border text-center">
                        <h2 class="font-black mb-8 uppercase text-xs text-slate-400">Нууц үг солих</h2>
                        <input type="password" id="new-pw" placeholder="Шинэ нууц үг" class="w-full p-4 border rounded-2xl mb-6 font-bold text-center outline-none bg-slate-50">
                        <button onclick="changePassword()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black uppercase text-[10px]">Шинэчлэх</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyTXEq2yPBaLWhYuXfoUJTHQitFltR2IeirdK-hbLLHj3PkulzXpe4tOk6_Hmyd0RFV/exec";
        let currentUser = JSON.parse(localStorage.getItem('ett_user'));
        let allOrders = [];

        window.onload = () => { if(currentUser) initSystem(); };

        async function handleLogin() {
            const code = document.getElementById('login-code').value;
            const pass = document.getElementById('login-pass').value;
            if(code === "admin" && pass === "12345") {
                currentUser = { code: "admin", ner: "Администратор", type: "admin" };
                localStorage.setItem('ett_user', JSON.stringify(currentUser));
                initSystem();
            } else { alert("Нэвтрэх эрхгүй!"); }
        }

        function initSystem() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-page').classList.remove('hidden');
            refreshData();
        }

        async function refreshData() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "get_all_data" }) });
                const data = await res.json();
                allOrders = data.orders || [];
                renderOrders(allOrders);
            } catch(e) { console.error(e); }
            document.getElementById('loading').style.display = 'none';
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-list-container');
            container.innerHTML = orders.slice().reverse().map(o => {
                const isPending = o.status === 'Хүлээгдэж буй';
                const dateStr = o.requestedDate ? new Date(o.requestedDate).toLocaleDateString() : '...';
                
                // Төлөвийн өнгө ба текст
                let statusHtml = '';
                if (o.status === 'Зөвшөөрсөн' || o.status === 'Олгосон') {
                    statusHtml = `<span class="status-badge status-olgoson">Шийдвэрлэсэн: Олгосон</span>`;
                } else if (o.status === 'Татгалзсан') {
                    statusHtml = `<span class="status-badge status-tatgalzsan">Шийдвэрлэсэн: Татгалзсан</span>`;
                } else {
                    statusHtml = `<span class="status-badge status-huleeh">Хүлээгдэж буй</span>`;
                }

                return `
                <div class="order-card">
                    <div class="card-grid">
                        <div>
                            <div class="label-text">Ажилтны нэр</div>
                            <div class="value-name">${o.ovog || ''} ${o.ner || 'Нэргүй'}</div>
                            <div class="value-sub">${o.role || 'Албан тушаалгүй'}</div>
                            <div class="text-[9px] font-bold text-slate-400 mt-1">ID: #${o.code || '000'}</div>
                        </div>

                        <div>
                            <div class="label-text">Нэг бүрийн хамгаалах хэрэгсэл</div>
                            <div class="value-item text-blue-700">${o.item || 'Тодорхойгүй'}</div>
                            <div class="value-detail">РАЗМЕР: ${o.size || '-'} | ТОО: ${o.quantity || '1'}</div>
                        </div>

                        <div class="text-center">
                            <div class="label-text">Төлөв</div>
                            ${statusHtml}
                            <div class="text-[8px] text-slate-400 mt-2 font-mono">${dateStr}</div>
                        </div>

                        <div class="flex flex-col gap-2">
                            ${isPending ? `
                                <button onclick="updateStatus('${o.id}', 'Зөвшөөрсөн')" class="btn-action btn-approve">
                                    <i class="fas fa-check-circle"></i> Олгох
                                </button>
                                <button onclick="updateStatus('${o.id}', 'Татгалзсан')" class="btn-action btn-reject">
                                    <i class="fas fa-times-circle"></i> Татгалзах
                                </button>
                            ` : `<div class="text-center text-[9px] font-black text-slate-300 italic uppercase">Шийдвэрлэсэн</div>`}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function updateStatus(id, status) {
            if(!confirm("Та энэ хүсэлтийг " + (status === 'Зөвшөөрсөн' ? 'ЗӨВШӨӨРӨХ' : 'ТАТГАЛЗАХ') + " гэж байна уу?")) return;
            document.getElementById('loading').style.display = 'flex';
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "update_status", id: id, status: status }) });
                refreshData();
            } catch(e) { alert("Алдаа гарлаа"); }
            document.getElementById('loading').style.display = 'none';
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function showTab(tab, btn) {
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(window.innerWidth < 1024) toggleSidebar();
        }
        function logout() { localStorage.removeItem('ett_user'); location.reload(); }
    </script>
</body>
</html>
